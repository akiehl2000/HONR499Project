---
title: "Exploratory Script"
author: "Adam Kiehl"
date: "2/11/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

Read in raw spike train data:
```{r}
raw_data <- read.csv('../Data/trialspikedata.csv')
```

Exploratory view of data:
```{r}
summary(raw_data)
```

`region`: Either CA1 or CA3  
`wire`: Number of wire on MEA  
`cell`: Number of cell on the wire  
`neuron_number`: Assigned number within the region  
`spiketime`: Exact time of spike  
`trial`: Trial number within the session  
`trialstart`: Assigned beginning of trial  
`offertime`: Time of memory stimulus  
`offer_type`: Either A or B, which stimulus given  
`outcome`: Either success (nonmatch) or failure (match)  
`nosepokestart`: Begin time for nosepoke  
`nosepokeend`: End time for nosepoke  
`completiontime`: Time when attempts to non-match  
`in_testing`: Whether spike occurs during a trial  
  
Generate data frame of binned count data:
```{r, warning=FALSE}
BINWIDTH <- 0.5

# function for binning spike train counts
make_counts <- function(times, start, end, width){
  cuts <- seq(start, end, width)
  if(cuts[length(cuts)] < end){
    cuts <- c(cuts, cuts[length(cuts)] + width)
  }  
  counts <- rep(0, length(cuts) - 1)
  b <- .bincode(times, cuts, right = FALSE)
  ub <- unique(b)
  counts[ub] <- tabulate(b)[ub]
  return(counts)
}

# filter out non-experimental recordings
testing_df <- raw_data %>% 
  filter(trial > 0, spiketime <= completiontime, spiketime >= trialstart)

# get unique trial, neuron pairs in data
trial_data <- testing_df %>%
  select(-spiketime) %>% 
  distinct()

# binned count data frame
binned_data <- testing_df %>% 
  group_by(region, neuron_number, trial) %>% 
  group_modify(~ {data_frame(bincount = make_counts(.x$spiketime, 
                                                    .x$trialstart[1], 
                                                    .x$completiontime[nrow(.x)], 
                                                    BINWIDTH),
                             binnumb = 1:length(bincount), 
                             binstart = (binnumb-1) * BINWIDTH + .x$trialstart[1],
                             binend = (binnumb) * BINWIDTH + .x$trialstart[1])}) %>%
  left_join(trial_data, by=c("region", "neuron_number", "trial"))

# pivot wider to make neurons predictors
binned_df  <- binned_data %>%
  mutate(neuron = paste(region, neuron_number, sep = '.')) %>%
  ungroup() %>%
  select(-c(region, neuron_number, wire, cell, outcome)) %>%
  pivot_wider(names_from = neuron, values_from = bincount)

# remove trials with missing data
neurons <- binned_data %>%
  mutate(neuron = paste(region, neuron_number, sep = '.')) %>%
  ungroup() %>%
  select(neuron) %>%
  unique() %>%
  unlist()
binned_df <- binned_df[complete.cases((binned_df %>% select(all_of(neurons)))), ]

# remove unnecessary data
remove(testing_df)
remove(trial_data)

# write to local .csv file
binned_df %>%
  write.csv('../Data/binned_df.csv')
```

Exploratory view of data frame:
```{r}
summary(binned_df)
```

```{r}
binned_data %>%
  mutate(neuron = paste(region, neuron_number, sep = '.')) %>%
  ungroup() %>%
  filter(trial == 3) %>%
  ggplot() +
  geom_col(aes(binstart, bincount)) +
  facet_wrap(factor(neuron, levels = names(binned_df)[13:48]) ~ .) +
  labs(title='Third Trial Neuron Spike Counts', x='Bin Number', y='Spike Count')
```

```{r}
norm_cc <- matrix(NA, nrow = length(c(pred_names, resp_names)), 
                  ncol = length(c(pred_names, resp_names))) %>% 
  as.data.frame() %>%
  mutate(var2 = c(pred_names, resp_names))
names(norm_cc) <- c(pred_names, resp_names, 'var2')
                     
for (var1 in c(pred_names, resp_names)) {
  for (var2 in c(pred_names, resp_names)) {
    if (var1 == var2) {
      break
    }
    
    temp <- ccf(binned_df[, var1], binned_df[, var2], plot = FALSE)
    norm_cc[which(norm_cc$var2 == var2), var1] <- max(temp$acf)
  }
}

var2_vec <- c()
for (i in 1:nrow(norm_cc)) {
  var2_vec <- c(var2_vec, rep(norm_cc$var2[i], (37 - i - 1)))
}
```

```{r, message=FALSE}
norm_cc %>%
  select(-var2) %>%
  pivot_longer(cols = c(pred_names, resp_names), 
               names_to = 'var1', values_to = 'corr') %>%
  na.omit(corr) %>%
  mutate(var2 = var2_vec) %>%
  ggplot() +
  geom_tile(aes(factor(var1, levels = c(pred_names, resp_names)), 
                factor(var2, levels = c(pred_names, resp_names)), 
                fill = corr)) +
  theme(axis.text.x = element_text(angle = 45, vjust = .65)) +
  labs(title = 'Normalized Cross Correlation Matrix', 
       x = 'Variable', y = 'Variable', fill = 'Correlation')
```
